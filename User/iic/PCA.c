 /**
  ******************************************************************************
  * @file    PCA.c
  * @author  Jerry
  * @date    10-Dec-2018
  *
  * @brief   PWM输出.
  *
  ******************************************************************************
  */
#include "include.h"

#define PCM_SAMPLES		(1338)

static uint8_t control_entry = FALSE;

const uint8_t PCM_Warn [PCM_SAMPLES]= { 
	0x7f,0x80,0x7f,0x7f,0x7f,0x80,0x7f,0x7f,0x7f,0x7e,0x7f,0x7f,0x7f,0x7f,0x80,0x7f,0x80,0x7f,0x80,0x7f,0x80,0x7f,0x80,0x7f,
	0x80,0x7f,0x80,0x81,0x86,0x95,0x94,0x90,0x8c,0x7a,0x50,0x56,0x5a,0x5f,0x64,0x76,0xa1,0x9c,0x99,0x95,0x90,0x80,0x53,0x5c,
	0x60,0x63,0x69,0x7b,0xa5,0x9d,0x9c,0x98,0x93,0x83,0x57,0x5c,0x62,0x66,0x6b,0x7c,0xa7,0xa0,0x9e,0x99,0x94,0x83,0x58,0x5f,
	0x63,0x66,0x6d,0x7c,0xa6,0xa0,0x9e,0x99,0x94,0x84,0x5b,0x61,0x64,0x67,0x6d,0x7d,0xa7,0xa1,0x9e,0x9a,0x94,0x84,0x5b,0x61,
	0x64,0x6b,0x81,0x93,0xbb,0xad,0xa8,0x7c,0x63,0x5f,0x34,0x44,0x4b,0x7b,0x95,0x99,0xc4,0xb5,0xad,0x7f,0x68,0x62,0x36,0x48,
	0x4d,0x7c,0x96,0x9b,0xc8,0xb6,0xaf,0x80,0x68,0x64,0x38,0x48,0x4f,0x7f,0x98,0x9d,0xc8,0xb8,0xb0,0x82,0x6a,0x65,0x3b,0x48,
	0x50,0x7d,0x99,0x9c,0xca,0xb8,0xb0,0x81,0x68,0x63,0x3a,0x4a,0x50,0x7e,0x99,0x9e,0xc7,0xb8,0xb1,0x80,0x68,0x62,0x39,0x49,
	0x51,0x81,0x9a,0x9c,0xc8,0xb8,0xb1,0x81,0x67,0x62,0x38,0x49,0x50,0x82,0xa3,0xa2,0xcc,0xbc,0xb2,0x77,0x59,0x56,0x2d,0x3f,
	0x48,0x86,0xa4,0xa6,0xd0,0xbd,0xb4,0x79,0x5b,0x59,0x2e,0x42,0x4a,0x86,0xa5,0xa7,0xd0,0xbe,0xb7,0x76,0x5a,0x5a,0x30,0x42,
	0x4b,0x87,0xa4,0xa6,0xcf,0xbd,0xb5,0x78,0x5a,0x58,0x30,0x42,0x4c,0x87,0xa5,0xa6,0xd1,0xbd,0xb3,0x76,0x5a,0x57,0x30,0x41,
	0x4f,0x92,0xab,0xad,0xd4,0xbf,0xab,0x67,0x4f,0x4d,0x27,0x3a,0x4d,0x93,0xaf,0xb1,0xd9,0xc2,0xad,0x69,0x51,0x52,0x2d,0x40,
	0x52,0x97,0xae,0xa9,0xd4,0xbf,0xa7,0x64,0x4f,0x54,0x2c,0x42,0x56,0x9b,0xaf,0xac,0xd2,0xbe,0xa7,0x66,0x50,0x55,0x2d,0x42,
	0x58,0x9c,0xae,0xad,0xd3,0xbd,0xa6,0x65,0x50,0x54,0x2f,0x41,0x58,0x9b,0xb0,0xad,0xd3,0xbc,0xa6,0x65,0x50,0x53,0x2d,0x41,
	0x59,0x9c,0xaf,0xac,0xd1,0xbc,0xa5,0x65,0x50,0x53,0x2e,0x43,0x5e,0x9f,0xb2,0xb0,0xd3,0xbc,0x9e,0x5a,0x4a,0x4e,0x2a,0x3f,
	0x62,0xab,0xbf,0xb9,0xdb,0xc4,0x9c,0x4a,0x38,0x3b,0x1c,0x34,0x5c,0xae,0xc2,0xbd,0xdb,0xc8,0x9e,0x4d,0x3c,0x40,0x1f,0x38,
	0x61,0xb2,0xc4,0xbf,0xdf,0xc8,0x9d,0x4c,0x3e,0x46,0x24,0x3c,0x66,0xb2,0xc1,0xb6,0xd8,0xc0,0x95,0x48,0x3e,0x45,0x27,0x3e,
	0x68,0xb4,0xc2,0xb8,0xd8,0xc1,0x96,0x4a,0x3e,0x46,0x27,0x3e,0x6b,0xb6,0xc2,0xba,0xda,0xc1,0x94,0x4b,0x3e,0x47,0x29,0x3f,
	0x6d,0xb6,0xc1,0xb9,0xda,0xc2,0x92,0x4b,0x3f,0x46,0x26,0x40,0x6e,0xb5,0xc2,0xb9,0xda,0xc0,0x90,0x4b,0x3e,0x45,0x26,0x42,
	0x6f,0xb3,0xc1,0xb8,0xda,0xc0,0x91,0x54,0x45,0x4c,0x2d,0x43,0x6c,0xa5,0xb5,0xad,0xce,0xb6,0x8d,0x58,0x48,0x4f,0x2b,0x47,
	0x71,0xa6,0xb5,0xac,0xcf,0xb7,0x8c,0x58,0x48,0x4f,0x2f,0x47,0x73,0xa5,0xb4,0xb0,0xcf,0xb7,0x8a,0x5a,0x49,0x4e,0x2f,0x48,
	0x75,0xa5,0xb6,0xae,0xce,0xb5,0x87,0x59,0x4a,0x4f,0x2e,0x49,0x77,0xa4,0xb5,0xaf,0xce,0xb3,0x86,0x58,0x4a,0x4e,0x2e,0x4b,
	0x79,0xa4,0xb5,0xb0,0xce,0xb2,0x83,0x59,0x4b,0x4f,0x30,0x4c,0x7a,0xa3,0xb5,0xaf,0xce,0xb0,0x83,0x59,0x4b,0x4f,0x2f,0x4e,
	0x7b,0xa1,0xb2,0xad,0xcd,0xae,0x80,0x59,0x4c,0x50,0x31,0x4e,0x7c,0xa1,0xb0,0xad,0xcd,0xaf,0x80,0x5b,0x4c,0x50,0x31,0x50,
	0x7d,0xa1,0xb2,0xac,0xcd,0xae,0x7e,0x5a,0x4c,0x4f,0x32,0x50,0x7e,0xa2,0xb2,0xad,0xcd,0xab,0x7e,0x5c,0x4c,0x4f,0x33,0x52,
	0x7f,0xa1,0xb0,0xac,0xce,0xaa,0x7d,0x5a,0x4d,0x50,0x31,0x55,0x80,0xa1,0xb0,0xad,0xcb,0xa7,0x7d,0x5b,0x4d,0x51,0x31,0x56,
	0x80,0xa3,0xb0,0xac,0xcb,0xa7,0x7e,0x5c,0x4f,0x52,0x32,0x58,0x80,0xa2,0xb1,0xac,0xcb,0xa6,0x7c,0x5c,0x4c,0x52,0x32,0x5a,
	0x84,0xa2,0xaf,0xad,0xcb,0xa3,0x7b,0x5c,0x4e,0x51,0x31,0x5c,0x82,0xa1,0xae,0xac,0xca,0xa2,0x7d,0x5a,0x4e,0x52,0x33,0x5c,
	0x83,0xa3,0xaf,0xac,0xcb,0xa1,0x7c,0x5d,0x4e,0x52,0x31,0x5e,0x81,0xa3,0xae,0xab,0xc8,0x9e,0x7a,0x5b,0x4f,0x52,0x32,0x60,
	0x81,0xa2,0xae,0xab,0xca,0x9c,0x7d,0x5b,0x4f,0x53,0x32,0x62,0x81,0xa0,0xae,0xab,0xc9,0x9d,0x7c,0x5c,0x4f,0x52,0x33,0x64,
	0x80,0xa1,0xb0,0xab,0xcc,0x9b,0x7e,0x5c,0x4f,0x52,0x34,0x65,0x81,0xa2,0xb0,0xa9,0xc8,0x97,0x7e,0x5b,0x4f,0x52,0x34,0x66,
	0x81,0xa1,0xae,0xaa,0xca,0x96,0x7d,0x5a,0x4f,0x54,0x35,0x67,0x80,0xa2,0xaf,0xab,0xcb,0x94,0x7f,0x5b,0x50,0x54,0x35,0x69,
	0x7f,0xa3,0xaf,0xaa,0xc9,0x94,0x7f,0x5b,0x4e,0x54,0x35,0x67,0x81,0xa3,0xad,0xaa,0xc9,0x90,0x7e,0x5e,0x4e,0x56,0x34,0x6a,
	0x7f,0xa2,0xae,0xa9,0xc7,0x91,0x7f,0x5b,0x4e,0x55,0x37,0x6c,0x7e,0xa0,0xae,0xa7,0xc7,0x91,0x80,0x5d,0x4e,0x54,0x35,0x6e,
	0x7f,0xa3,0xaf,0xa8,0xc5,0x91,0x7f,0x5d,0x4e,0x55,0x38,0x6f,0x80,0xa3,0xb0,0xa8,0xc4,0x8d,0x81,0x5a,0x4e,0x55,0x38,0x6f,
	0x7d,0xa3,0xb1,0xa8,0xc4,0x8c,0x83,0x5d,0x4e,0x56,0x3a,0x72,0x7e,0xa3,0xb0,0xa8,0xc3,0x8c,0x81,0x5a,0x4e,0x55,0x39,0x73,
	0x7d,0xa3,0xb2,0xa7,0xc2,0x8c,0x82,0x5d,0x4d,0x57,0x3b,0x72,0x7b,0xa1,0xb2,0xa6,0xc1,0x8c,0x82,0x5d,0x4f,0x57,0x3d,0x75,
	0x7b,0xa0,0xb1,0xa5,0xc2,0x8b,0x82,0x5e,0x4d,0x56,0x3f,0x73,0x7d,0xa5,0xb7,0xad,0xae,0x7c,0x72,0x4d,0x40,0x53,0x61,0x93,
	0x96,0xbc,0xc7,0xb0,0x9d,0x6c,0x66,0x45,0x39,0x52,0x65,0x96,0x98,0xbb,0xc5,0xae,0x99,0x68,0x65,0x43,0x37,0x52,0x67,0x95,
	0x98,0xbb,0xc6,0xad,0x99,0x68,0x66,0x44,0x38,0x52,0x67,0x95,0x98,0xb9,0xc7,0xac,0x98,0x67,0x65,0x43,0x36,0x52,0x69,0x95,
	0x99,0xb9,0xc6,0xab,0x95,0x68,0x66,0x43,0x36,0x54,0x6b,0x9b,0xa2,0xb2,0xb0,0x9e,0x7f,0x59,0x57,0x59,0x61,0x6f,0x8a,0xae,
	0xac,0xa6,0x9d,0x8f,0x72,0x52,0x53,0x59,0x63,0x71,0x8d,0xac,0xab,0xa5,0x9c,0x8c,0x6f,0x52,0x53,0x5a,0x62,0x71,0x8f,0xac,
	0xab,0xa4,0x9c,0x8d,0x6f,0x52,0x53,0x5a,0x62,0x71,0x90,0xac,0xab,0xa4,0x9c,0x8d,0x6d,0x53,0x53,0x5b,0x62,0x71,0x91,0xac,
	0xab,0xa3,0x9c,0x8d,0x6c,0x53,0x53,0x5b,0x63,0x71,0x93,0xac,0xab,0xa2,0x9c,0x8c,0x6a,0x53,0x54,0x5d,0x64,0x75,0x94,0xa5,
	0xa7,0x9d,0x98,0x88,0x6c,0x5f,0x5d,0x66,0x6a,0x79,0x93,0x9f,0xa2,0x99,0x96,0x87,0x6c,0x60,0x5e,0x67,0x6b,0x79,0x94,0x9f,
	0xa0,0x97,0x94,0x85,0x6a,0x62,0x61,0x69,0x6c,0x7b,0x95,0x9e,0x9f,0x97,0x95,0x85,0x6a,0x62,0x61,0x69,0x6c,0x7a,0x96,0x9d,
	0x9f,0x96,0x94,0x85,0x69,0x62,0x60,0x6a,0x6d,0x7d,0x95,0x97,0x9b,0x90,0x90,0x81,0x6f,0x70,0x6a,0x73,0x73,0x81,0x91,0x90,
	0x95,0x8c,0x8d,0x80,0x6f,0x70,0x6b,0x74,0x74,0x80,0x91,0x90,0x91,0x8a,0x8a,0x7d,0x6e,0x71,0x71,0x79,0x78,0x84,0x93,0x8f,
	0x8f,0x87,0x88,0x7b,0x6d,0x70,0x71,0x79,0x79,0x84,0x93,0x8f,0x8e,0x87,0x87,0x7b,0x6d,0x70,0x72,0x7a,0x79,0x84,0x93,0x90,
	0x8e,0x86,0x86,0x7b,0x6d,0x70,0x72,0x79,0x79,0x85,0x92,0x90,0x8d,0x86,0x86,0x7b,0x6e,0x70,0x73,0x7a,0x79,0x85,0x92,0x90,
	0x8e,0x86,0x83,0x78,0x6c,0x6d,0x72,0x7b,0x81,0x86,0x8e,0x8f,0x8b,0x83,0x80,0x7e,0x73,0x72,0x76,0x7d,0x80,0x82,0x8e,0x90,
	0x8b,0x83,0x81,0x7e,0x72,0x70,0x75,0x7c,0x7f,0x82,0x8d,0x90,0x8b,0x83,0x81,0x7e,0x72,0x70,0x75,0x78,0x7b,0x7e,0x8a,0x8d,
	0x8a,0x8a,0x86,0x83,0x77,0x73,0x75,0x75,0x79,0x7b,0x87,0x8d,0x8a,0x8a,0x87,0x84,0x77,0x72,0x75,0x75,0x78,0x7b,0x87,0x8c,
	0x8a,0x8a,0x86,0x84,0x79,0x72,0x75,0x75,0x78,0x7a,0x86,0x8c,0x8a,0x8a,0x87,0x84,0x79,0x72,0x75,0x75,0x78,0x7a,0x85,0x8c,
	0x8a,0x8a,0x87,0x84,0x79,0x72,0x75,0x75,0x78,0x7a,0x84,0x8d,0x8a,0x8a,0x87,0x85,0x7a,0x72,0x75,0x75,0x79,0x7d,0x83,0x86,
	0x85,0x84,0x83,0x81,0x7f,0x7e,0x7f,0x7e,0x7f,0x80,0x81,0x80,0x81,0x80,0x7f,0x7f,0x7e,0x7f,0x7e,0x7f,0x7f,0x80,0x7f,0x80,
	0x7f,0x80,0x7f,0x7e,0x7f,0x7e,0x7f,0x7f,0x7f,0x80,0x7f,0x80,0x7f,0x80,0x7f,0x7e,0x7f,0x7e 
}; 

 ////////////////////////////////////////////
 // 
 // 环形缓冲区操作（缓存用于填充PCA的数据）
 //
 /////////////////////////////////////////////
uint8_t pca_code_buf[8] ;	// z增大到16
uint8_t pca_buf_wr=0;		// 写指针
uint8_t pca_buf_rd=0;		// 读指针

uint8_t pac_code_ax=0;
uint16_t pca_over_cnt=0;


void Dac_Init(void)
{
  
	GPIO_InitTypeDef GPIO_InitStructure;
	DAC_InitTypeDef DAC_InitType;

	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE );	  //使能PORTA通道时钟
   	RCC_APB1PeriphClockCmd(RCC_APB1Periph_DAC, ENABLE );	  //使能DAC通道时钟 

	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_4 |GPIO_Pin_5;				 // 端口配置
 	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AIN; 		 //模拟输入
 	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
 	GPIO_Init(GPIOA, &GPIO_InitStructure);
	GPIO_SetBits(GPIOA,GPIO_Pin_4|GPIO_Pin_5)	;//PA.4 输出高
					
	DAC_InitType.DAC_Trigger=DAC_Trigger_None;	//不使用触发功能 TEN1=0
	DAC_InitType.DAC_WaveGeneration=DAC_WaveGeneration_None;//不使用波形发生
	DAC_InitType.DAC_LFSRUnmask_TriangleAmplitude=DAC_LFSRUnmask_Bit0;//屏蔽、幅值设置
	DAC_InitType.DAC_OutputBuffer=DAC_OutputBuffer_Disable ;	//DAC1输出缓存关闭 BOFF1=1
	DAC_Init(DAC_Channel_1,&DAC_InitType);	 //初始化DAC通道1
	DAC_Init(DAC_Channel_2,&DAC_InitType);	 //初始化DAC通道1

	DAC_Cmd(DAC_Channel_1, ENABLE);  //使能DAC1
	DAC_Cmd(DAC_Channel_2, ENABLE);  //使能DAC1
  
	DAC_SetChannel1Data(DAC_Align_8b_R, DUTY_50);  //8位右对齐数据格式设置DAC值
	DAC_SetChannel2Data(DAC_Align_8b_R, ~DUTY_50);  //8位右对齐数据格式设置DAC值
}

// 用于... 判断缓冲区是否有空余
uint8_t PCA_buf_fill_validate(void)
{
	uint8_t next_wr, cc;

	if(pca_buf_wr != (unsigned char)(sizeof(pca_code_buf)-1) ) // 到了末尾？	
		next_wr = pca_buf_wr + 1;
	else
		next_wr = 0;		// 绕回到 0
	cc = (next_wr!=pca_buf_rd);

	#ifdef __UT_DEBUG__x
	if(!cc)
	{
		char temp[7]="w= r= "; 
		temp[2] = 0x30+	pca_buf_wr	;
		temp[5] = 0x30+	pca_buf_rd	; 
		DEBUG_PUTS_(temp);
	}
	#endif
	return cc;
}

// 用于... 填写数据到缓冲区
// 使用前，先调用PCA_buf_fill_validate()确认缓冲区未满 
void PCA_buf_fill_code(uint8_t pcm)   
{
	// 把PCM码放入缓冲区
	pca_code_buf[pca_buf_wr] = pcm;	 

	// 移动缓冲区的写指针
	if(pca_buf_wr != (unsigned char)(sizeof(pca_code_buf)-1) ) // 到了末尾？	
		pca_buf_wr++;
	else
		pca_buf_wr = 0;		// 绕回到 0

	if (control_entry == FALSE)
	{
		control_entry = TRUE;
		//NS4160_AB_type();
	}
	TIM_Cmd(TIM4,ENABLE); 	// 开 PCA 中断
}

// 用于PCA中断调用，读缓冲区的数据至PCA寄存器
void PCA_buf_read_code(void)
{							 
	if( pca_buf_rd != pca_buf_wr ) 	
	{								  
		/* 把缓冲区的PCM码读出	*/		
		pac_code_ax	 = pca_code_buf[pca_buf_rd];		 
											
		/* 移动缓冲区的读指针	*/		  
		if(pca_buf_rd != (uint8_t)(sizeof(pca_code_buf)-1) ) 
			pca_buf_rd++;										 
		else													  
			pca_buf_rd = 0;										 
	}															  
	else														 
	{															 
		pac_code_ax = DUTY_50;  /*无效时的默认值：50%duty cycle;	*/

		//TIM_GenerateEvent(TIM5, TIM_EventSource_Update);
		TIM_Cmd(TIM4,DISABLE); //   关PCA中断
		if (control_entry == TRUE)
		{
			control_entry = FALSE;
			//NS4160_Disable();
		}
	}															
}

/////////////////////////////////////////////////////////
// 用程序内置的PCM数据测试PCA
void PCA_Test_SampleVox(void)
{
	volatile uint16_t sz;

	NS4160_D_type();
	//Delay_Ms(100);
	
	for(sz=0; sz<PCM_SAMPLES; sz++)
	{
		while( !PCA_buf_fill_validate() ) 	// 等待PCA缓冲有空
			Delay_Xus(10);

		PCA_buf_fill_code( PCM_Warn[sz] ); // 填入PCA缓冲
	}
	for(sz=0; sz<200; sz++);	 // delay
}

void TIM4_IRQHandler(void)   //TIM4中断
{
	static uint8_t cnt_over = 0;
	if (TIM_GetITStatus(TIM4, TIM_IT_Update) != RESET) //检查指定的TIM中断发生与否:TIM 中断源 
	{
		TIM_ClearFlag(TIM4, TIM_FLAG_Update);  //清除TIMx的中断待处理位:TIM 中断源 
		cnt_over++;
		//if (cnt_over >=5)
		{
			cnt_over = 0;
			pca_over_cnt++;
			#if 1
			if(pca_over_cnt%2 == 0)	 
			{
				LED_Set(LED_RUN, OFF);
			}
			else
			{
				LED_Set(LED_RUN, ON);
			}
			PCA_buf_read_code();	 // 把缓冲区的PCM码填入 /
			DAC_SetChannel1Data(DAC_Align_8b_R, pac_code_ax);
			DAC_SetChannel2Data(DAC_Align_8b_R, ~pac_code_ax);
			#endif
			#if 0
		if(pca_over_cnt==0xffff/80)	 LED_Set(LED_COM, OFF);
   		if(pca_over_cnt==0xffff/70)	{LED_Set(LED_COM, ON); pca_over_cnt=0;}
	
		PCA_buf_read_code();	 // 把缓冲区的PCM码填入 /
		DAC_SetChannel1Data(DAC_Align_8b_R, pac_code_ax);
		DAC_SetChannel2Data(DAC_Align_8b_R, ~pac_code_ax);
		#endif
		//TIM_SetCompare3(TIM4,pac_code_ax);	
		}
	}
}

/////////////////////////////////////////////////
